# =============================================================================
# Logrotate Configuration for Nginx (Docker Volume)
# =============================================================================
#
# INSTALLATION:
# 1. Copy this file to /etc/logrotate.d/nginx-tea on the VPS
# 2. Test configuration: sudo logrotate -d /etc/logrotate.d/nginx-tea
# 3. Force rotation test: sudo logrotate -f /etc/logrotate.d/nginx-tea
#
# This configuration rotates nginx logs from the Docker volume:
# /var/lib/docker/volumes/ops_nginx-logs/_data/
#
# Rotation policy:
# - Daily rotation
# - Keep 14 days of logs
# - Compress old logs (after 1 day delay)
# - Don't error if log file is missing
# - Don't rotate empty logs
# - Create new log with proper permissions
# - Reload nginx after rotation
#
# =============================================================================

/var/lib/docker/volumes/ops_nginx-logs/_data/access.log
/var/lib/docker/volumes/ops_nginx-logs/_data/error.log
/var/lib/docker/volumes/ops_nginx-logs/_data/rsc_access.log
/var/lib/docker/volumes/ops_nginx-logs/_data/rsc_error.log
{
    # Rotate daily
    daily
    
    # Keep 14 days of logs
    rotate 14
    
    # Compress old logs
    compress
    
    # Delay compression by 1 day (allows fail2ban to process recent logs)
    delaycompress
    
    # Don't error if log file is missing
    missingok
    
    # Don't rotate if log is empty
    notifempty
    
    # Create new log file with permissions
    create 0644 root root
    
    # Use date as suffix for rotated files
    dateext
    dateformat -%Y%m%d
    
    # Reload nginx after rotation (send USR1 signal to reopen log files)
    postrotate
        docker exec tea_nginx nginx -s reopen 2>/dev/null || true
    endscript
    
    # Share scripts between all log files
    sharedscripts
}
