# =============================================================================
# GitHub Actions - Production Deployment Workflow
# =============================================================================
# 
# This workflow automates deployment to production VPS.
# 
# Triggers:
# - Manual trigger (workflow_dispatch)
# - Push to main branch (optional, uncomment below)
#
# Required GitHub Secrets:
# - VPS_HOST: VPS IP address or hostname
# - VPS_USER: SSH user (e.g., root or deploy)
# - VPS_SSH_KEY: Private SSH key for authentication
# - GHCR_TOKEN: GitHub Container Registry token (optional, for image registry)
#
# Optional Secrets (if using GHCR):
# - POSTGRES_PASSWORD
# - REDIS_PASSWORD
# - SECRET_KEY
# - AZURE_AD_CLIENT_SECRET
#
# =============================================================================

name: Deploy to Production

on:
  # Manual trigger
  workflow_dispatch:
    inputs:
      skip_backup:
        description: 'Skip database backup'
        required: false
        default: 'false'
        type: boolean
      skip_build:
        description: 'Skip Docker image rebuild'
        required: false
        default: 'false'
        type: boolean
  
  # Uncomment to deploy on push to main
  # push:
  #   branches:
  #     - main
  #   paths-ignore:
  #     - '**.md'
  #     - 'docs/**'

# Prevent concurrent deployments
concurrency:
  group: production-deployment
  cancel-in-progress: false

jobs:
  # ===========================================================================
  # Job 1: Build and Test
  # ===========================================================================
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    
    steps:
      # Pin to specific commit SHAs for supply chain security
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
      
      - name: Set up Python
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b  # v5.3.0
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt
      
      - name: Install backend dependencies
        run: |
          cd backend
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
      
      - name: Run backend tests
        run: |
          cd backend
          pytest -v --tb=short
      
      - name: Set up Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af  # v4.1.0
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install frontend dependencies
        run: |
          cd frontend
          npm ci
      
      - name: Build frontend
        run: |
          cd frontend
          npm run build
      
      - name: Lint code
        run: |
          cd backend
          ruff check . || true
          cd ../frontend
          npm run lint || true

  # ===========================================================================
  # Job 2: Build and Push Docker Images (Optional - if using GHCR)
  # ===========================================================================
  # Uncomment if you want to use GitHub Container Registry
  # build-images:
  #   name: Build Docker Images
  #   runs-on: ubuntu-latest
  #   needs: build-and-test
  #   
  #   permissions:
  #     contents: read
  #     packages: write
  #   
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #     
  #     - name: Set up Docker Buildx
  #       uses: docker/setup-buildx-action@v3
  #     
  #     - name: Login to GitHub Container Registry
  #       uses: docker/login-action@v3
  #       with:
  #         registry: ghcr.io
  #         username: ${{ github.actor }}
  #         password: ${{ secrets.GITHUB_TOKEN }}
  #     
  #     - name: Build and push backend image
  #       uses: docker/build-push-action@v5
  #       with:
  #         context: ./backend
  #         push: true
  #         tags: |
  #           ghcr.io/${{ github.repository }}/backend:latest
  #           ghcr.io/${{ github.repository }}/backend:${{ github.sha }}
  #         cache-from: type=gha
  #         cache-to: type=gha,mode=max
  #     
  #     - name: Build and push frontend image
  #       uses: docker/build-push-action@v5
  #       with:
  #         context: ./frontend
  #         push: true
  #         tags: |
  #           ghcr.io/${{ github.repository }}/frontend:latest
  #           ghcr.io/${{ github.repository }}/frontend:${{ github.sha }}
  #         cache-from: type=gha
  #         cache-to: type=gha,mode=max

  # ===========================================================================
  # Job 3: Deploy to VPS
  # ===========================================================================
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    needs: build-and-test
    # needs: [build-and-test, build-images]  # If using GHCR
    
    environment:
      name: production
      url: https://app.technasiummbh.nl
    
    steps:
      # Pin to specific commit SHAs for supply chain security
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
      
      - name: Setup SSH
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          # Use StrictHostKeyChecking=accept-new for security
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true
      
      - name: Test SSH connection
        run: |
          set -euo pipefail
          ssh -o StrictHostKeyChecking=accept-new ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "echo 'SSH connection successful'"
      
      - name: Preflight checks on VPS
        run: |
          set -euo pipefail
          ssh -o StrictHostKeyChecking=accept-new ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'ENDSSH'
            set -euo pipefail
            
            echo "==> Preflight checks"
            cd /opt/team-evaluatie-app
            
            # Fetch latest code
            echo "==> Fetching latest code from GitHub"
            git fetch origin
            
            # Checkout specific commit or branch
            echo "==> Checking out commit: ${{ github.sha }}"
            git checkout ${{ github.sha }} || git checkout ${{ github.ref_name }}
            
            # Verify .env.prod exists
            echo "==> Checking .env.prod file"
            if [ ! -f .env.prod ]; then
              echo "ERROR: .env.prod not found!"
              exit 1
            fi
            
            # Check required environment variables
            echo "==> Validating required environment variables"
            required_vars="FRONTEND_URL POSTGRES_PASSWORD REDIS_PASSWORD"
            for var in $required_vars; do
              if ! grep -q "^${var}=" .env.prod; then
                echo "ERROR: Required variable $var not found in .env.prod"
                exit 1
              fi
            done
            echo "Environment variables: OK"
            
            # Validate docker compose configuration
            echo "==> Validating Docker Compose configuration"
            if ! docker compose --env-file .env.prod -f ops/docker/compose.prod.yml config > /dev/null; then
              echo "ERROR: Docker Compose configuration is invalid!"
              exit 1
            fi
            echo "Docker Compose config: OK"
            
            echo "==> Preflight checks complete"
          ENDSSH
      
      - name: Deploy to VPS
        run: |
          set -euo pipefail
          ssh -o StrictHostKeyChecking=accept-new ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'ENDSSH'
            set -euo pipefail
            
            echo "==> Navigating to application directory"
            cd /opt/team-evaluatie-app
            
            echo "==> Building deployment options"
            DEPLOY_OPTS=""
            
            if [ "${{ inputs.skip_backup }}" = "true" ]; then
              DEPLOY_OPTS="$DEPLOY_OPTS --no-backup"
            fi
            
            if [ "${{ inputs.skip_build }}" = "true" ]; then
              DEPLOY_OPTS="$DEPLOY_OPTS --no-build"
            fi
            
            echo "==> Running deployment script"
            bash scripts/deploy.sh $DEPLOY_OPTS
            
            echo "==> Deployment complete"
          ENDSSH
      
      - name: Verify deployment
        run: |
          set -euo pipefail
          ssh -o StrictHostKeyChecking=accept-new ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'ENDSSH'
            set -euo pipefail
            
            cd /opt/team-evaluatie-app
            
            echo "==> Checking container status"
            docker compose --env-file .env.prod -f ops/docker/compose.prod.yml ps
            
            echo ""
            echo "==> Recent logs from services"
            docker compose --env-file .env.prod -f ops/docker/compose.prod.yml logs --tail=200 nginx backend
            
            echo ""
            echo "==> Checking ports 80 and 443"
            ss -lntp | grep -E ':80|:443' || echo "Port check: some ports may not be bound yet"
          ENDSSH
      
      - name: Health check
        run: |
          set -euo pipefail
          ssh -o StrictHostKeyChecking=accept-new ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'ENDSSH'
            set -euo pipefail
            
            echo "==> Waiting for services to stabilize..."
            sleep 30
            
            # Frontend health check with retries and exponential backoff
            echo ""
            echo "==> Checking frontend health (https://app.technasiummbh.nl/)"
            for attempt in {1..10}; do
              sleep_time=$((attempt * 3))
              if curl -fsS --max-time 10 https://app.technasiummbh.nl/ > /dev/null 2>&1; then
                echo "✅ Frontend is up and responding (attempt $attempt)"
                break
              else
                if [ $attempt -eq 10 ]; then
                  echo "❌ Frontend health check failed after 10 attempts"
                  echo "==> Dumping logs for troubleshooting"
                  cd /opt/team-evaluatie-app
                  docker compose --env-file .env.prod -f ops/docker/compose.prod.yml ps
                  docker compose --env-file .env.prod -f ops/docker/compose.prod.yml logs --tail=100 frontend nginx
                  exit 1
                fi
                echo "⏳ Attempt $attempt: Frontend not ready, waiting ${sleep_time}s..."
                sleep $sleep_time
              fi
            done
            
            # API health check with retries and exponential backoff
            echo ""
            echo "==> Checking API health (https://app.technasiummbh.nl/api/v1/health)"
            for attempt in {1..10}; do
              sleep_time=$((attempt * 3))
              response=$(curl -fsS --max-time 10 https://app.technasiummbh.nl/api/v1/health 2>/dev/null || echo "")
              if echo "$response" | grep -q '"status".*:.*"ok"'; then
                echo "✅ API is up and healthy (attempt $attempt)"
                echo "Response: $response"
                break
              else
                if [ $attempt -eq 10 ]; then
                  echo "❌ API health check failed after 10 attempts"
                  echo "Last response: $response"
                  echo "==> Dumping logs for troubleshooting"
                  cd /opt/team-evaluatie-app
                  docker compose --env-file .env.prod -f ops/docker/compose.prod.yml ps
                  docker compose --env-file .env.prod -f ops/docker/compose.prod.yml logs --tail=100 backend nginx
                  exit 1
                fi
                echo "⏳ Attempt $attempt: API not healthy, waiting ${sleep_time}s..."
                sleep $sleep_time
              fi
            done
            
            echo ""
            echo "✅ All health checks passed!"
          ENDSSH
      
      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "✅ Deployment successful!"
          else
            echo "❌ Deployment failed!"
            # Add notification logic here (Slack, Discord, email, etc.)
          fi

  # ===========================================================================
  # Job 4: Post-deployment checks
  # ===========================================================================
  post-deployment:
    name: Post-deployment Checks
    runs-on: ubuntu-latest
    needs: deploy
    if: success()
    
    steps:
      - name: Setup SSH
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true
      
      - name: Final health verification
        run: |
          set -euo pipefail
          ssh -o StrictHostKeyChecking=accept-new ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'ENDSSH'
            set -euo pipefail
            
            echo "==> Final health verification"
            
            # Check frontend
            echo ""
            echo "==> Checking frontend availability"
            for attempt in {1..5}; do
              if curl -fsS --max-time 10 https://app.technasiummbh.nl/ > /dev/null 2>&1; then
                echo "✅ Attempt $attempt: Frontend is healthy"
                break
              fi
              if [ $attempt -eq 5 ]; then
                echo "❌ Frontend not responding after 5 attempts"
                exit 1
              fi
              echo "⏳ Attempt $attempt: Waiting..."
              sleep 10
            done
            
            # Check API
            echo ""
            echo "==> Checking API health"
            response=$(curl -fsS --max-time 10 https://app.technasiummbh.nl/api/v1/health 2>/dev/null || echo "")
            if echo "$response" | grep -q '"status".*:.*"ok"'; then
              echo "✅ API is healthy"
              echo "Response: $response"
            else
              echo "❌ API health check failed"
              echo "Response: $response"
              exit 1
            fi
          ENDSSH
      
      - name: Deployment summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Site health: OK" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ API health: OK" >> $GITHUB_STEP_SUMMARY
          echo "- Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- Branch: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- Deployed at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
