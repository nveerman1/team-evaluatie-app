# =============================================================================
# GitHub Actions - Production Deployment Workflow
# =============================================================================
# 
# This workflow automates deployment to production VPS.
# 
# Triggers:
# - Manual trigger (workflow_dispatch)
# - Push to main branch (optional, uncomment below)
#
# Required GitHub Secrets:
# - VPS_HOST: VPS IP address or hostname
# - VPS_USER: SSH user (e.g., root or deploy)
# - VPS_SSH_KEY: Private SSH key for authentication
# - GHCR_TOKEN: GitHub Container Registry token (optional, for image registry)
#
# Optional Secrets (if using GHCR):
# - POSTGRES_PASSWORD
# - REDIS_PASSWORD
# - SECRET_KEY
# - AZURE_AD_CLIENT_SECRET
#
# =============================================================================

name: Deploy to Production

on:
  # Manual trigger
  workflow_dispatch:
    inputs:
      skip_backup:
        description: 'Skip database backup'
        required: false
        default: 'false'
        type: boolean
      skip_build:
        description: 'Skip Docker image rebuild'
        required: false
        default: 'false'
        type: boolean
  
  # Uncomment to deploy on push to main
  # push:
  #   branches:
  #     - main
  #   paths-ignore:
  #     - '**.md'
  #     - 'docs/**'

# Prevent concurrent deployments
concurrency:
  group: production-deployment
  cancel-in-progress: false

jobs:
  # ===========================================================================
  # Job 1: Build and Test
  # ===========================================================================
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt
      
      - name: Install backend dependencies
        run: |
          cd backend
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
      
      - name: Run backend tests
        run: |
          cd backend
          pytest -v --tb=short
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install frontend dependencies
        run: |
          cd frontend
          npm ci
      
      - name: Build frontend
        run: |
          cd frontend
          npm run build
      
      - name: Lint code
        run: |
          cd backend
          ruff check . || true
          cd ../frontend
          npm run lint || true

  # ===========================================================================
  # Job 2: Build and Push Docker Images (Optional - if using GHCR)
  # ===========================================================================
  # Uncomment if you want to use GitHub Container Registry
  # build-images:
  #   name: Build Docker Images
  #   runs-on: ubuntu-latest
  #   needs: build-and-test
  #   
  #   permissions:
  #     contents: read
  #     packages: write
  #   
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #     
  #     - name: Set up Docker Buildx
  #       uses: docker/setup-buildx-action@v3
  #     
  #     - name: Login to GitHub Container Registry
  #       uses: docker/login-action@v3
  #       with:
  #         registry: ghcr.io
  #         username: ${{ github.actor }}
  #         password: ${{ secrets.GITHUB_TOKEN }}
  #     
  #     - name: Build and push backend image
  #       uses: docker/build-push-action@v5
  #       with:
  #         context: ./backend
  #         push: true
  #         tags: |
  #           ghcr.io/${{ github.repository }}/backend:latest
  #           ghcr.io/${{ github.repository }}/backend:${{ github.sha }}
  #         cache-from: type=gha
  #         cache-to: type=gha,mode=max
  #     
  #     - name: Build and push frontend image
  #       uses: docker/build-push-action@v5
  #       with:
  #         context: ./frontend
  #         push: true
  #         tags: |
  #           ghcr.io/${{ github.repository }}/frontend:latest
  #           ghcr.io/${{ github.repository }}/frontend:${{ github.sha }}
  #         cache-from: type=gha
  #         cache-to: type=gha,mode=max

  # ===========================================================================
  # Job 3: Deploy to VPS
  # ===========================================================================
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    needs: build-and-test
    # needs: [build-and-test, build-images]  # If using GHCR
    
    environment:
      name: production
      url: https://yourdomain.com  # Replace with your domain
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts
      
      - name: Test SSH connection
        run: |
          ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "echo 'SSH connection successful'"
      
      - name: Deploy to VPS
        run: |
          ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'ENDSSH'
            set -e
            
            echo "==> Navigating to application directory"
            cd /opt/team-evaluatie-app
            
            echo "==> Pulling latest code"
            git fetch origin
            git checkout main
            git pull origin main
            
            echo "==> Building deployment options"
            DEPLOY_OPTS=""
            
            if [ "${{ inputs.skip_backup }}" = "true" ]; then
              DEPLOY_OPTS="$DEPLOY_OPTS --no-backup"
            fi
            
            if [ "${{ inputs.skip_build }}" = "true" ]; then
              DEPLOY_OPTS="$DEPLOY_OPTS --no-build"
            fi
            
            echo "==> Running deployment script"
            bash scripts/deploy.sh $DEPLOY_OPTS
            
            echo "==> Deployment complete"
          ENDSSH
      
      - name: Verify deployment
        run: |
          ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'ENDSSH'
            cd /opt/team-evaluatie-app
            docker compose -f ops/docker/compose.prod.yml ps
            docker compose -f ops/docker/compose.prod.yml logs --tail=50
          ENDSSH
      
      - name: Health check
        run: |
          echo "Waiting for services to stabilize..."
          sleep 30
          
          # Check if site is responding
          if curl -f -s https://yourdomain.com/health > /dev/null; then
            echo "✅ Site is up and healthy"
          else
            echo "❌ Site health check failed"
            exit 1
          fi
      
      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "✅ Deployment successful!"
          else
            echo "❌ Deployment failed!"
            # Add notification logic here (Slack, Discord, email, etc.)
          fi

  # ===========================================================================
  # Job 4: Post-deployment checks
  # ===========================================================================
  post-deployment:
    name: Post-deployment Checks
    runs-on: ubuntu-latest
    needs: deploy
    if: success()
    
    steps:
      - name: Check site availability
        run: |
          for i in {1..5}; do
            if curl -f -s https://yourdomain.com/health > /dev/null; then
              echo "Attempt $i: Site is healthy"
              exit 0
            fi
            echo "Attempt $i: Waiting..."
            sleep 10
          done
          echo "Site is not responding after 5 attempts"
          exit 1
      
      - name: Check API health
        run: |
          if curl -f -s https://yourdomain.com/api/v1/health > /dev/null; then
            echo "API is healthy"
          else
            echo "API health check failed"
            exit 1
          fi
      
      - name: Deployment summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Site health: OK" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ API health: OK" >> $GITHUB_STEP_SUMMARY
          echo "- Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- Branch: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- Deployed at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
